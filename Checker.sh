#!/bin/bash

## On the producer side
# Clean up the bucket
aws s3 rm --recursive s3://adx-text-gary-jul-21/

# scan it and create a report
clamscan -r -d /var/lib/clamav/ malware/ | tee malware/clamav.report

# Create sha256sums and save to file
find malware/ -type f -exec sha256sum '{}' \; > malware/malware.sha256sum

# Sync up to S3 bucket
aws s3 sync   --no-guess-mime-type --content-type 'application/octet-stream' malware/ s3://adx-text-gary-jul-21/
exit

## On the other side

#clear up the destination bucket
aws s3 rm --recursive s3://whatevere this is called

#remove old, create new malware dest dir
rm -rf malware/
mkdir malware

#run the ADX pull

#get the contents from the s3 bucket onto out s3 instance
aws s3 sync   --no-guess-mime-type --content-type 'application/octet-stream' s3://adx-text-gary-jul-21/  malware/ > sync_log

# move the sha256 sums and clamvreport out so we dont include them in the check
mv malware/malware.sha256sums .
mv malware/clamav.report .

# Here you will need the sha256 sums from the other side, which we now check
sha256sum -c malware.sha256sum > sha256sum_check.log

#scan it with Clam
clamscan -r -d /var/lib/clamav/ malware/ | tee clamav-dest.report

# compare it with the one off the other box
diff clamav.report clamav-dest.report

